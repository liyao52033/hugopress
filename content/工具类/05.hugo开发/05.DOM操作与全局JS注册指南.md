---
title: DOM操作与全局JS注册指南
date: 2025-12-18 20:56:26
url: /pages/f625bb
type: docs
description: 本文详细介绍了Hugo项目中DOM操作的实用技巧，包括选择器使用、事件监听、元素操作等，并重点讲解了如何将JavaScript函数和对象注册为全局变量，支持模块化开发。这些内容帮助开发者高效构建交互式网页，确保代码结构清晰且易于维护。
weight: 50
tags: ["hugo"]
categories:
  - 工具类
  - hugo开发
author:
  name: liyao
  link: https://xiaoying.org.cn
---

## DOM操作

### 基本DOM选择器

项目中常用的DOM选择器方法：

```javascript
// 通过ID选择元素
const navbar = document.getElementById("topnav");
const mybutton = document.getElementById("back-to-top");

// 通过类名选择元素
const navbarToggler = document.querySelector('.navbar-toggler');
const navbarCollapse = document.querySelector('.navbar-collapse');
const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')

// 通过标签名选择元素
var elements = document.getElementById("navigation").getElementsByTagName("a");

// 使用更复杂的选择器
const targetElement = document.querySelector(targetId);
const dropdowns = document.querySelectorAll('.dropdown');
```

### 事件监听器

#### DOMContentLoaded事件

`DOMContentLoaded`是项目中最常用的事件，确保DOM完全加载后再执行脚本：

```javascript
// 基本用法
document.addEventListener('DOMContentLoaded', function() {
    // 在这里执行DOM操作
    renderMathInElement(document.getElementById("content"), {
        // 配置选项
    });
});

// 箭头函数写法
document.addEventListener('DOMContentLoaded', () => {
    window.ImageHandler.init();
});
```

#### 其他常用事件监听

```javascript
// 滚动事件
window.addEventListener('scroll', function() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    // 处理滚动逻辑
});

// 点击事件
document.addEventListener('click', function(event) {
    var isClickInsideElement = suggestions.contains(event.target);
    if (!isClickInsideElement) {
        suggestions.classList.add('d-none');
    }
});

// 键盘事件
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        this.closeZoom();
    }
});

// 窗口大小变化事件
window.addEventListener('resize', function() {
    if (window.innerWidth >= 992) {
        // 处理响应式逻辑
    }
});
```

### DOM操作实例

#### 元素样式操作

```javascript
// 添加/移除类
navbar.classList.add("nav-sticky");
navbar.classList.remove("scrolled");
navbar.classList.toggle('open');

// 直接修改样式
mybutton.style.display = "block";
overlay.style.borderBottom = '1px solid var(--alert-border-color)'
```

#### 元素属性操作

```javascript
// 获取属性
const isExpanded = navbarToggler.getAttribute('aria-expanded') === 'true';
const href = elem.target.getAttribute("href");

// 设置属性
navbarToggler.setAttribute('aria-expanded', 'false');
element.setAttribute('data-collapse-state', 'collapsed');
```

#### 创建和插入元素

```javascript
// 创建新元素
const overlay = document.createElement('div');
overlay.className = 'image-overlay';

const collapseBtn = document.createElement('button');
collapseBtn.setAttribute('type', 'button');

// 克隆元素
const clonedElement = this.cloneImageElement(element);

// 插入元素
document.body.appendChild(overlay);
parent.insertBefore(wrapper, block);
wrapper.appendChild(block);
```

## 全局JS注册

### 直接挂载到window对象

最简单直接的方式是将函数或对象挂载到window对象上：

```javascript
// 注册全局函数
window.toggleMenu = function() {
    const isActive = legacyToggle.classList.contains('active');
    if (isActive) {
        legacyToggle.classList.remove('active');
        navigation.classList.remove('show');
    } else {
        legacyToggle.classList.add('active');
        navigation.classList.add('show');
    }
};

// 注册全局对象
window.ImageHandler = {
    init() {
        // 初始化逻辑
    },
    toggleZoom(element) {
        // 缩放功能
    },
    closeZoom() {
        // 关闭功能
    }
};

// 注册全局工具函数
window.sanitizeHTML = function (str) {
    return str.replace(/[^\w. ]/gi, function (c) {
        return '&#' + c.charCodeAt(0) + ';';
    });
};
```

### 模块导出与全局注册结合

对于模块化代码，可以同时使用ES6模块导出和全局注册：

```javascript
// echarts-entry.js 示例
import * as echarts from 'echarts/core';
// ...其他导入

// 注册所有用到的模块
echarts.use([
    CalendarComponent,
    HeatmapChart,
    TooltipComponent,
    VisualMapComponent,
    CanvasRenderer
]);

// 挂载到window全局，保持原有代码调用逻辑不变
window.echarts = echarts;

// bootstrap.js 示例
import Tab from "/js/bootstrap/src/tab";
import Collapse from "/js/bootstrap/src/collapse";
import Dropdown from "/js/bootstrap/src/dropdown";
import ScrollSpy from "js/bootstrap/src/scrollspy";
import Tooltip from "js/bootstrap/src/tooltip";

export default {
    Tab,
    Collapse,
    Dropdown,
    ScrollSpy,
    Tooltip
}

// 同时注册到全局
window.Collapse = Collapse;
window.Dropdown = Dropdown;
window.Tooltip = Tooltip;
```

### 类的全局注册

对于面向对象的代码，可以将类实例注册为全局变量：

```javascript
// code-block-manager.js 示例
class CodeBlockManager {
    constructor() {
        // 初始化代码
    }
    
    init() {
        // 初始化方法
    }
    
    reinit() {
        // 重新初始化方法
    }
}

// 创建全局实例
window.codeBlockManager = new CodeBlockManager();

// 导出类以供其他脚本使用
if (typeof module !== 'undefined' && module.exports) {
    module.exports = CodeBlockManager;
}
```

### 兼容性处理

某些情况下，需要检查全局变量是否已存在：

```javascript
// plausible.html 示例
<script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>

// 检查依赖是否存在
if (typeof window.docsearch === 'function' && document.getElementById('docsearch')) {
    // 使用docsearch
}

// 检查Bootstrap是否可用
if ((typeof bootstrap === 'undefined' || !bootstrap.Collapse) && (typeof window.Collapse === 'undefined')) {
    // 提供回退方案
}
```

## 最佳实践

### 事件委托

使用事件委托减少事件监听器数量，提高性能：

```javascript
// 不推荐：为每个元素添加监听器
document.querySelectorAll('.dropdown').forEach(dropdown => {
    dropdown.addEventListener('click', handler);
});

// 推荐：使用事件委托
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('zoomable') ||
        e.target.closest('.zoomable')) {
        const element = e.target.classList.contains('zoomable') ?
            e.target : e.target.closest('.zoomable');
        this.toggleZoom(element);
    }
});
```

### 防抖与节流

对于频繁触发的事件（如scroll、resize），使用防抖或节流：

```javascript
// 防抖函数
function debounce(fn, delay) {
    let timer = null;
    return function () {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, arguments), delay);
    };
}

// 使用防抖处理滚动事件
const handleScroll = debounce(checkVifTrigger, 100);
window.addEventListener('scroll', handleScroll);
```

### 条件初始化

根据页面内容或条件初始化功能：

```javascript
// 只在存在特定元素时初始化
if (document.getElementById("sidebar")) {
    var elements = document.getElementById("sidebar").getElementsByTagName("button");
    // 初始化侧边栏功能
}

// 检查页面是否有代码块
hasCodeBlockContent() {
    const selectors = [
        'pre > code[class*="language-"]',
        'code[class*="language-"]',
        '.highlight',
        '.chroma'
    ];

    for (const selector of selectors) {
        if (document.querySelector(selector)) {
            return true;
        }
    }
    return false;
}
```

### 模块化与全局注册的平衡

虽然全局注册很方便，但应尽量保持代码模块化：

```javascript
// 1. 使用模块系统组织代码
import { ImageHandler } from './image-handler.js';

// 2. 在需要的地方注册到全局
window.ImageHandler = ImageHandler;

// 3. 在其他文件中通过全局对象使用
// 而不是直接导入模块
window.addEventListener('DOMContentLoaded', () => {
    window.ImageHandler.init();
});
```

## 常见应用场景

### 导航栏交互

```javascript
// 响应式导航栏
document.addEventListener('DOMContentLoaded', function() {
    const navbarToggler = document.querySelector('.navbar-toggler');
    const navbarCollapse = document.querySelector('.navbar-collapse');
    
    if (navbarToggler && navbarCollapse) {
        navbarToggler.addEventListener('click', function(e) {
            e.preventDefault();
            const isExpanded = navbarToggler.getAttribute('aria-expanded') === 'true';
            
            if (isExpanded) {
                navbarCollapse.classList.remove('show');
                navbarToggler.setAttribute('aria-expanded', 'false');
            } else {
                navbarCollapse.classList.add('show');
                navbarToggler.setAttribute('aria-expanded', 'true');
            }
        });
    }
});
```

### 平滑滚动

```javascript
// 平滑滚动到目标元素
const links = document.querySelectorAll('a[href^="#"]');
links.forEach(function(link) {
    link.addEventListener('click', function(e) {
        const targetId = this.getAttribute('href');
        if (targetId === '#') return;
        
        const targetElement = document.querySelector(targetId);
        if (targetElement && navbar) {
            e.preventDefault();
            
            const navbarHeight = navbar.offsetHeight;
            const targetPosition = targetElement.offsetTop - navbarHeight - 20;
            
            window.scrollTo({
                top: targetPosition,
                behavior: 'smooth'
            });
        }
    });
});
```

### 图片处理

```javascript
// 图片点击放大功能
window.ImageHandler = {
    init() {
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('zoomable') ||
                e.target.closest('.zoomable')) {
                const element = e.target.classList.contains('zoomable') ?
                    e.target : e.target.closest('.zoomable');
                this.toggleZoom(element);
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.closeZoom();
            }
        });
    },
    
    toggleZoom(element) {
        let overlay = document.querySelector('.image-overlay');
        if (overlay) {
            this.closeZoom();
        } else {
            this.openZoom(element);
        }
    }
};

// 初始化
window.addEventListener('DOMContentLoaded', () => {
    window.ImageHandler.init();
});
```

## 总结

在Hugo项目中，DOM操作和全局JS注册是创建交互式网页的关键技术。通过合理使用事件监听器、DOM选择器和全局注册模式，可以构建出响应式、高性能的用户界面。同时，遵循最佳实践如事件委托、防抖节流和条件初始化，可以确保代码的可维护性和性能。