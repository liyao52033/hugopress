<!-- 引入第三方成品脚本，无需构建压缩，以免破坏原有代码 -->
{{ $dayjs := resources.Get (printf "/%s/%s" ($.Scratch.Get "pathName") "js/dayjs.min.js") }}
{{ $relativeTime := resources.Get (printf "/%s/%s" ($.Scratch.Get "pathName") "js/relativeTime.min.js") }}
{{ $thirdSlice := slice $dayjs $relativeTime -}}

{{ if site.Params.docs.toc | default true }}
  {{ if eq .Site.Params.docs.scrollSpy true -}}
    {{ $simplescrollspy := resources.Get (printf "/%s/%s" ($.Scratch.Get "pathName") "js/simple-scrollspy.min.js") }}
    {{ $thirdSlice = $thirdSlice | append $simplescrollspy -}}
  {{ end -}}
{{ end -}}

<!-- 引入 algolia DocSearch 脚本 -->
{{ if and (.Site.Params.docsearch.appID) (.Site.Params.docsearch.apiKey) -}}
  {{ $docsearch := resources.Get (printf "/%s/%s" ($.Scratch.Get "pathName") "js/docsearch.min.js") }}
  {{ $thirdSlice = $thirdSlice | append $docsearch -}}
{{ end }}

<!-- FlexSearch -->
{{ if or (not (isset .Site.Params.flexsearch "enabled")) (eq .Site.Params.flexsearch.enabled true) -}}
    {{ if and (.Site.Params.docsearch.appID) (.Site.Params.docsearch.apiKey) -}}
    {{ else }}
        {{ $flexSearch := resources.Get (printf "/%s/%s" ($.Scratch.Get "pathName") "js/flexsearch.bundle.js") }}
        {{ $thirdSlice = $thirdSlice | append $flexSearch }}
    {{ end }}
{{ end }}

{{ $thirdJS := $thirdSlice | resources.Concat (printf "/%s/%s" ($.Scratch.Get "pathName") "js/third.js") -}}

<!-- 引入自定义脚本 -->
{{ $app := resources.Get (printf "/%s/%s" ($.Scratch.Get "pathName") "js/app.js") -}}
{{ $slice := slice $app -}}

<!-- 引入图片缩放脚本 -->
{{ $imageZoomJS := resources.Get (printf "/%s/%s" ($.Scratch.Get "pathName") "js/imageZoom.js") -}}
{{ $slice = $slice | append $imageZoomJS -}}

<!-- Dark Mode -->
{{ if eq .Site.Params.docs.darkMode true -}}
  {{ $darkModeInit := resources.Get (printf "/%s/%s" ($.Scratch.Get "pathName") "js/darkmode-init.js") -}}
  {{ $slice = $slice | append $darkModeInit -}}
{{ end -}}

<!-- 引入代码块管理器JS -->
{{ $codeBlockManager := resources.Get (printf "/%s/%s" ($.Scratch.Get "pathName") "js/code-block-manager.js") }}
{{ $slice = $slice | append $codeBlockManager -}}

<!-- 引入 Prism.js 代码高亮 -->
{{ if eq .Site.Params.docs.prism true -}}
{{ $prism := resources.Get (printf "/%s/%s" ($.Scratch.Get "pathName") "js/prism.js") }}
{{- $opts := dict
"params" (dict "langPath" (urls.JoinPath .Site.BaseURL "docs/js/components/"))
-}}
{{ $prism := $prism | js.Build $opts -}}
{{ $slice = $slice | append $prism -}}
{{ end -}}

<!-- 引入滚动监听脚本 -->
{{ if site.Params.docs.toc | default true }}
  {{ if eq .Site.Params.docs.scrollSpy true -}}
    {{ $scrollspyScript := resources.Get (printf "/%s/%s" ($.Scratch.Get "pathName") "js/scrollspy-script.js") }}
    {{ $slice = $slice | append $scrollspyScript -}}
  {{ end -}}
{{ end -}}

{{ if site.Params.docs.tocMobile | default true }}
  {{ $tocmobilescrollspy := resources.Get (printf "/%s/%s" ($.Scratch.Get "pathName") "js/toc-mobile-scrollspy.js") }}
  {{ $slice = $slice | append $tocmobilescrollspy -}}
{{ end -}}

<!-- 引入v-if核心JS（使用Hugo资源管道处理） -->
{{ $vifCoreJs := resources.Get (printf "/%s/%s" ($.Scratch.Get "pathName") "js/v-if-core.js") }}
{{ $slice = $slice | append $vifCoreJs -}}

{{ $Js := $slice | resources.Concat (printf "/%s/%s" ($.Scratch.Get "pathName") "js/custom.js") -}}

{{/* 统一构建配置 */}}
{{ $params := dict }}
{{ $sourceMap := cond hugo.IsProduction "" "inline" }}
{{ $opts := dict
"sourceMap" $sourceMap
"minify" hugo.IsProduction
"target" "es2018"
"params" $params
"treeShaking" true
}}

{{/* 构建合并后的自定义JS */}}
{{ $customJs := $Js | js.Build $opts -}}

<!-- 合并第三方成品脚本与自定义脚本 -->
{{ $commbineJs := slice $thirdJS $customJs -}}
{{ $finalJs := $commbineJs | resources.Concat (printf "/%s/%s" ($.Scratch.Get "pathName") "js/bundle.js") -}}

{{/* 生产环境添加指纹 */}}
{{ if hugo.IsProduction }}
  {{ $finalJs = $finalJs | fingerprint "sha384" -}}
{{ end }}

{{/* 输出script标签 */}}
<script src="{{ $finalJs.RelPermalink }}" blocking="render" {{ if hugo.IsProduction }}integrity="{{ $finalJs.Data.Integrity }}" {{ end -}} defer></script>

<script>
  (function () {
    try {
      var path = window.location && window.location.pathname ? window.location.pathname : "/";
      function norm(u) {
        if (!u) return "/";
        var s = u.trim();
        if (!s.startsWith("/")) s = "/" + s;
        if (s.length > 1 && s.endsWith("/")) s = s.slice(0, -1);
        return s;
      }
      var cur = norm(path);
      var links = document.querySelectorAll('a.sidebar-nested-link[data-url], a.sidebar-root-link[data-url]');
      var matched = null;
      links.forEach(function (a) {
        var t = norm(a.getAttribute('data-url') || "");
        if (t === cur) matched = a;
      });
      if (matched) {
        // 清理旧的 current，避免同级多选
        document.querySelectorAll('.sidebar-menu li.current').forEach(function (el) { el.classList.remove('current'); });

        var li = matched.closest('li');
        if (li) li.classList.add('current');

        // 仅在面包屑进入的分区页（多为 Section 列表页，URL 多以 / 结尾）里，限制“当前分支”仅高亮匹配项
        try {
          // 基于 location.pathname 判断是否为目录页（_index.md 对应的路径通常以 / 结尾）
          var curPath = window.location && window.location.pathname ? window.location.pathname : '';
          var href = matched.getAttribute('data-url') || matched.getAttribute('href') || '';

          // 统一规范化比较，避免前缀/尾斜杠/大小写/编码差异
          function norm(u) {
            try {
              // 仅取路径部分
              var a = document.createElement('a');
              a.href = u;
              var p = (a.pathname || u || '').toString();
              // 解码、去查询和锚点（a.pathname 已无查询锚点）
              p = decodeURI(p);
              // 统一分隔、多斜杠
              p = p.replace(/\/{2,}/g, '/');
              // 去掉 index.html 等
              p = p.replace(/\/index\.html?$/i, '/');
              // 统一末尾斜杠：目录页需以 / 结尾
              if (!/\/$/.test(p)) p = p + '/';
              return p;
            } catch (e) { return (u || '').toString(); }
          }

          var nHref = href ? norm(href) : '';
          var nPath = curPath ? norm(curPath) : '';

          // 目录页模式：规范化后相等 或 pathname 以链接为前缀，且链接以 / 结尾（视为 _index.md）
          if (nHref && nPath && /\/$/.test(nHref) && (nHref === nPath || nPath.startsWith(nHref))) {
            // 目录页：只高亮父元素
            // 1) 全局清理所有 current（覆盖 SSR 预置）
            var sidebar = document.querySelector('.sidebar-menu');
            if (sidebar) {
              sidebar.querySelectorAll('li.current').forEach(function (el) { el.classList.remove('current'); });
            }
            // 2) 仅父元素 li 高亮
            if (li) li.classList.add('current');
          }
        } catch (e) { /* noop */ }

        // 展开祖先（仅展开，不给祖先加 current）
        var el = li ? li.parentElement : null;
        while (el) {
          if (el.classList && el.classList.contains('sidebar-submenu')) {
            el.classList.add('d-block');
            var dd = el.closest('.sidebar-dropdown');
            if (dd) dd.classList.add('active');
            el = dd ? dd.parentElement : el.parentElement;
          } else {
            el = el.parentElement;
          }
        }
      }
    } catch (e) {
      if (window.console && console.debug) console.debug('sidebar pathname highlight:', e);
    }
  })();
</script>